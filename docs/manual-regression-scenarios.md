# Мануальные сценарии регресса

## Регистрация и утверждение свободного механика (базовый/премиум)
**Given** публичная форма регистрации свободного агента доступна.  
**When** пользователь вводит телефон `+79995550101`, пароль, анкету с ФИО, датой рождения, опытом, регионом, отмечает самозанятость и отправляет заявку.  
**Then** создаётся пользователь с ролью MECHANIC и account_type `FREE_MECHANIC_BASIC`, профиль в статусе unverified/inactive, заявка видна Администрации.

**When** Администрация утверждает заявку и выбирает тариф `FREE_MECHANIC_PREMIUM`.  
**Then** аккаунт становится активным и верифицированным, account_type обновляется на `FREE_MECHANIC_PREMIUM`, создаётся личный склад, в кабинете механика отображается премиальный доступ.

## Заявка на аттестацию и её утверждение
**Given** активный механик с подтверждённым профилем.
**When** он отправляет аттестацию с requestedGrade `MIDDLE`.
**Then** заявка создаётся в статусе `PENDING` и отображается у Администрации.
**When** Администрация подтверждает заявку.
**Then** статус меняется на `APPROVED`, в профиле выставлены флаги верификации/сертификации, механик виден в базе специалистов.
**And** менеджер клуба открывает «База аттестованных специалистов», фильтрует по региону и грейду, находит одобренного механика с карточкой (ФИО, стаж, регион, формат работы, рейтинг).

## Работа со складом и заявками на запчасти
**Given** свободный механик с личным складом и деталью `ZIP-200`.
**When** он создаёт maintenance request и добавляет позицию с catalog_number `ZIP-200`.
**Then** позиция автоматически помечается как доступная, связывается с личным складом и отражает адрес хранения.

## Личный ZIP-склад свободного механика
**Given** свободный механик авторизован и в данных есть личный склад.
**When** он открывает раздел «Личный ZIP-склад» из кабинета или нижнего меню.
**Then** отображается название склада, список позиций с каталожными номерами, названиями, количеством, резервом, уникальностью и адресом хранения.
**When** он использует строку поиска по каталожному номеру/названию или фильтры «Уникальные», «Низкий остаток», «Давно не проверяли».
**Then** список обновляется согласно фильтрам без ошибок и зависаний, карточки открываются с деталями и переходом к созданию заявки на обслуживание.

## Поставка, частичная приёмка, жалоба на поставщика
**Given** менеджер оформил заказ поставщику и получил частичную поставку.  
**When** в приёмке отмечается accepted_quantity меньше запрошенного и добавляется комментарий.  
**Then** заказ получает статус частичной приёмки, на склад начисляется принятый объём.  
**When** менеджер создаёт жалобу с is_complaint=true и complaint_title.  
**Then** в supplier_reviews фиксируется спор, рейтинг поставщика пересчитывается, статус спора отображается в кабинете Администрации.

## Ветка «механик не может выполнить работы»
**Given** у механика есть активная заявка на обслуживание.  
**When** он отмечает одну или несколько позиций help_requested=true через кнопку «Нужна помощь».  
**Then** создаётся событие MECHANIC_HELP_REQUESTED, уведомления уходят менеджеру клуба и Администрации.  
**When** менеджер подтверждает или отклоняет запрос с комментарием.  
**Then** статус запроса обновляется, механик видит ответ в своём кабинете, в уведомлениях фиксируется действие.

## Просмотр техинформации и истории обслуживания
**Given** менеджер клуба авторизован.  
**When** он открывает экран «Техническая информация».  
**Then** отображаются модели, серийные номера, проценты состояния, даты последнего/следующего ТО и компоненты для оборудования его клуба.  
**When** он переходит в «Журнал работ» и фильтрует по периоду.
**Then** видит только работы своего клуба, исполнителей, использованные запчасти, даты создания/завершения.
**When** он открывает вкладку «Предупреждения».
**Then** видит просроченное и приближающееся ТО, превышенный ресурс деталей с красной подсветкой критичных кейсов.
**When** он открывает «Оповещения/Обращения».
**Then** отображаются события помощи механикам, споры с поставщиками и ответы Администрации, относящиеся к его клубу.

## Работа кабинета Администрации
**Given** пользователь с ролью ADMIN и account_type MAIN_ADMIN.  
**When** он открывает кабинеты заявок: регистрации, аттестации, запросы помощи, споры с поставщиками.  
**Then** отображаются все очереди с фильтрами и статусами; админ может утверждать/отклонять регистрации, менять account_type свободных механиков, привязывать или отвязывать механиков к клубам, обновлять complaint_status у supplier_reviews и статусы обращений.

## Фронтенд e2e проверки
**Given** новый пользователь открывает мастер «Регистрация свободного механика».
**When** он по шагам заполняет ФИО, дату рождения, телефон в маске +7 (XXX) XXX-XX-XX, регион, стаж общий/по боулингу, навыки, отмечает самозанятость/ИП и отправляет заявку.
**Then** форма проходит валидации, создаётся заявка со статусом PENDING, экран кабинета показывает баннер ожидания и контакты поддержки.

**Given** Администрация одобрила заявку свободного механика c тарифом PREMIUM.
**When** механик авторизуется заново и открывает «Кабинет свободного механика».
**Then** виден тип аккаунта FREE_MECHANIC_PREMIUM, активные функции ZIP-склада, заявки и аттестации, баннер одобрения с датой решения.

**Given** свободный механик заполняет форму «Аттестация тех. специалиста» (описание опыта, желаемый грейд).
**When** отправляет заявку и ждёт решения Администрации.
**Then** история показывает статус PENDING, после APPROVED меняется на APPROVED с комментарием, а в «База специалистов» менеджера карточка механика появляется с грейдом и регионом.

**Given** свободный механик открывает «Личный ZIP-склад» из нижнего меню.
**When** вводит частичный каталожный номер и включает фильтр «Уникальные».
**Then** список фильтруется по наличию и флагу is_unique, карточки отображают адрес хранения, last_checked и кнопки перехода к заявке на обслуживание.

**Given** механик создаёт новую заявку на обслуживание.
**When** через «Подбор запчасти» проходит по дереву компонентов, добавляет позицию, меняет количество и сохраняет черновик.
**Then** в списке позиций сразу подсвечивается наличие «Есть на складе»/«Нужно заказывать» на основе ответа бэкенда, статус заявки «Черновик» отображается до отправки.

**Given** менеджер открывает экран «Заказы поставщикам» и выбирает заказ со статусом частичной приёмки.
**When** в диалоге приёмки указывает accepted_quantity < quantity, комментарий и сохраняет.
**Then** позиция получает статус частичной приёмки, итоговые количества для размещения отображаются, после сохранения можно оставить отзыв/жалобу и обновлять статус спора.

**Given** механик на экране работы нажимает «Нужна помощь» по выбранным позициям и добавляет комментарий.
**When** запрос отправлен.
**Then** на его экране статус запроса меняется на ожидание, в уведомлениях менеджера и Администрации появляется событие, а после подтверждения/отклонения статусы и уведомления обновляются.

**Given** менеджер клуба открывает «Техническая информация».
**When** фильтрует по дорожке и периоду ТО.
**Then** видит только оборудование своего клуба с датами last/next maintenance, condition_percentage и предупреждениями о просроченном ТО.

**Given** MAIN_ADMIN открывает кабинет Администрации.
**When** модератор одобряет регистрацию, обновляет привязку механик↔клуб, переводит механика в свободные агенты и закрывает спор поставщика.
**Then** все действия завершаются без ошибок, статусы обновляются в списках, ответные уведомления уходят пользователям.
